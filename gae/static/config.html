<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css" />
		<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
		<title>Pebble NetAtmo</title>
	</head>
	<body>
		<div data-role="page" id="page1">
			<div data-role="header" id="header">
				<button id="b-cancel" data-icon="back" data-iconpos="left" data-inline="true" data-mini="true">Cancel</button>
				<h1>Pebble NetAtmo</h1>
			</div>
			<div data-role="content">
				<fieldset id="devices" data-role="controlgroup">
    			    <legend>Choose the main device :</legend>
    			</fieldset>

				<button data-theme="b" id="b-authorize">Authorize</button>

				<div class="ui-body ui-body-b" style="display:none">
					<fieldset class="ui-grid-a">
						<div class="ui-block-a"><button type="submit" data-theme="d" id="btn-cancel">Cancel</button></div>
						<div class="ui-block-b"><button type="submit" data-theme="a" id="btn-submit">Ok</button></div>
					</fieldset>
				</div>
			</div>
			<button id="b-submit" data-theme="b" data-icon="check" data-iconpos="right">Save</button>
		</div>
		<script>
			function getHashParams() {
				var hashParams = {};
				var e,
					a = /\+/g,  // Regex for replacing addition symbol with a space
					r = /([^&;=]+)=?([^&;]*)/g,
					d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
					q = window.location.search.substring(1);
				while (e = r.exec(q))
					hashParams[d(e[1])] = d(e[2]);
				return hashParams;
			}

			function authorize() {
				window.location = "auth";
			}

			function getDevices(access_token){
				var response = $.ajax({
						dataType: "json",
						url: "https://api.netatmo.net/api/devicelist",
						data: {access_token: access_token, app_type: 'app_station'},
						async: false}).responseText;
				return JSON.parse(response);
			}

			function refreshAccessToken(refresh_token){
				var response = $.ajax({
						dataType: "json",
						url: "http://pebble-netatmo.appspot.com/auth/refresh",
						data: {refresh_token: refresh_token},
						async: false}).responseText;
				return JSON.parse(response);
			}
			
			var data = {};
			$().ready(function() {
				data = getHashParams();
				if(data.refresh_token){
					$("#b-authorize").hide();

					var refreshToken = refreshAccessToken(data.refresh_token);

					data.access_token = refreshToken.access_token;
					data.refresh_token = refreshToken.refresh_token;
					data.expires_in = refreshToken.expires_in;

					var devicesResult = getDevices(data.access_token);
					console.log(JSON.stringify(devicesResult));
					$.each( devicesResult.body.devices, function( i, item ) {
					  $( "<input>" ).
					  	attr( "type", "radio" ).
					  	attr( "name", i ).
					  	attr( "id", item._id ).
					  	attr( "value", item._id ).
					  	attr( "checked", "checked" ).
					  	appendTo( "#devices" );
					  $( "<label>" ).
					  	attr( "for", item._id ).
					  	text( item.station_name ).
					  	appendTo( "#devices" );
					});
					$("#devices").trigger('create');
					$("#devices").show();
				}
				else {
					$("#devices").hide();
					$("#b-submit").hide();
				}

				$("#b-cancel").click(function() {
					console.log("Cancel");
					window.location = "pebblejs://close#";
				});

				$("#b-submit").click(function() {
					data.main_device = $("#devices :radio:checked").val();
					console.log(JSON.stringify(data));
					var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(data));
					window.location = location;
				});

				$("#b-authorize").click(function() {
					authorize();
				});
			});
		</script>
	</body>
</html>